EFCS-DBT系統是一個結匯交易管理系統，用於記錄和管理匯兌交易及相關用戶資訊。系統採用SQL Server數據庫進行數據存儲和管理。

## 數據庫架構

系統包含三個主要資料表：

### 1. 匯兌交易表 (dbo.exchange_transactions)

此表格用於存儲所有匯兌交易的詳細信息，包括客戶個人資料和交易明細。

主要欄位：

- `id`：交易唯一標識符 (主鍵)
- `name`：客戶姓名
- `id_number`：身份證號碼
- `birth_date`：出生日期
- `nationality`：國籍
- `residence_permit_issue_date`：居留許可發行日期
- `residence_permit_expiry_date`：居留許可到期日期
- `phone_number`：電話號碼
- `currency`：貨幣類型
- `exchange_amount`：匯兌金額
- `remittance_code`：匯款代碼
- `transaction_description`：交易描述
- `transaction_time`：交易時間
- `transaction_number`：交易編號
- `created_at`：記錄創建時間
- `updated_at`：記錄更新時間

**注意事項：**

- 部分個人資訊欄位允許為null
- 交易金額使用decimal(18,2)格式，確保了精度和範圍
- 交易時間使用datetime格式存儲

### 2. 用戶表 (dbo.users)

此表格用於管理系統用戶（操作員）資訊。

主要欄位：

- `id`：用戶唯一標識符 (主鍵)
- `username`：用戶名
- `password`：密碼（應為加密存儲）
- `created_at`：帳戶創建時間
- `updated_at`：帳戶更新時間

### 3. 用戶令牌表 (dbo.user_tokens)

此表格用於管理用戶身份驗證令牌，實現系統的登入和會話管理功能。

主要欄位：

- `id`：令牌記錄唯一標識符 (主鍵)
- `user_id`：關聯的用戶ID (外鍵)
- `token_id`：令牌ID
- `token`：令牌值
- `server_name`：伺服器名稱
- `issued_at`：頒發時間
- `expiry_date`：過期時間

## 表格關係

- `user_tokens`表通過`user_id`外鍵與`users`表關聯，建立了用戶和其身份驗證令牌之間的關係。
- 每個用戶可以有多個令牌記錄，實現多裝置登入或令牌更新功能。

## 重建資料庫指南

若需要重新建立資料庫，請按照以下步驟：

1. 使用附帶的SQL腳本創建表格結構
2. 確保按照正確的順序創建表格（先創建users表，再創建user_tokens表，因為存在外鍵關係）
3. 根據需要導入現有數據（如有備份）
4. 設置適當的訪問權限和用戶角色

## 注意事項與建議

1. **資料安全**：由於系統存儲了客戶敏感個人資訊，應特別注意數據庫安全性，包括加密、訪問控制及定期備份等措施。
2. **性能優化**：針對大量交易記錄的查詢，建議在交易號碼、交易時間等常用查詢欄位上創建索引。
3. **系統擴展**：未來如需擴展，可考慮添加更多相關表格，如匯率表、客戶表（與交易表分離）等。
4. **合規性**：確保系統符合相關數據保護法規，特別是關於個人身份信息的處理和存儲。


# JWT認證系統與歷史比對清單系統工作交接日報

## 一、系統概述

本系統由兩個主要部分組成：JWT認證系統和歷史比對清單系統。

### JWT認證系統

實現基於JWT的用戶認證機制，包含登入驗證、Token管理及權限驗證等功能。系統採用模組化設計，主要分為以下幾個核心模組：

1. 認證控制模組 (AuthController)
2. 認證服務模組 (AuthService)
3. JWT工具模組 (JwtUtil)
4. 金鑰管理模組 (PemKeyManager)
5. 用戶倉庫模組 (UserRepository)
6. Token倉庫模組 (TokenRepository)
7. 資料庫存取模組 (Database)

### 歷史比對清單系統

專門用於處理和比對交易資料，避免重複交易，主要功能包括檔案上傳、資料驗證、重複交易檢查及資料儲存等。

## 二、系統流程說明

### A. JWT認證系統流程

根據流程圖，認證系統主要包含以下工作流程：

### 1. 資料上傳與處理流程

- 開始 → 上傳今日數據CSV檔案
- 檢查檔案格式是否正確
    - 格式正確 → 檢查資料完整性
    - 格式錯誤 → 顯示格式錯誤訊息 → 返回上傳步驟
- 檢查資料完整性
    - 資料完整 → 產生報表
    - 資料不完整 → 標註資料有缺失但仍可繼續 → 生成業務報表
- 用戶決定是否重新上傳或繼續處理
- 處理完成後進行驗證
- 檢查今日是否為月底
    - 是 → 進行額外處理步驟
    - 否 → 進行正常結案流程
- 最終資料入庫 → 結束

### B. 歷史比對清單系統流程

根據PDF文件，歷史比對清單系統包含以下核心流程：

### 1. 檔案上傳與解析（步驟一）

- 接收並驗證結匯清單CSV檔案（限制10MB以內）
- 解析CSV檔案內容為交易資料
- 檢查檔案格式和基本資料完整性
- 生成操作Token用於追蹤整個處理流程

### 2. 資料預覽與確認（步驟二）

- 顯示解析後的交易資料預覽
- 提供交易資料的統計資訊
- 執行詳細的資料格式驗證
- 確認資料正確性後進入下一步

### 3. 重複交易檢查（步驟三）

- 比對新交易與歷史資料
- 檢查條件：交易序號、身分證字號、金額
- 生成重複交易報告
- 分離重複和非重複交易

### 4. 最終處理與儲存（步驟四）

- 檢查當日是否已有上傳記錄
- 確認是否需要覆蓋既有資料
- 儲存非重複交易到資料庫
- 更新處理狀態和操作日誌

### 2. 用戶認證流程 (案例一：密碼驗證)

- Client 透過 POST /auth/login 發送登入請求
- AuthController 接收用戶名和密碼
- AuthService 執行登入邏輯
- 透過 UserRepository 查詢用戶資訊
- 驗證用戶密碼
    - 失敗 → 返回 HTTP 400 錯誤 (密碼錯誤)
    - 成功 → 生成 JWT Token

### 3. Token驗證流程 (案例二：Token解析驗證)

- Client 發送帶有 Token 的請求
- AuthService 執行 validateToken() 方法
- JwtUtil 驗證 Token 有效性
    - 失敗 → 拋出 TokenVerificationException → 返回 HTTP 401 錯誤
    - 成功 → 允許訪問資源

### 4. 資料存取流程 (案例三：資料操作異常)

- Client 發送 GET /user/profile 請求
- AuthController 轉發至 getUserProfile() 方法
- 透過 UserRepository 查詢用戶
- 資料庫訪問
    - 成功 → 返回用戶資料
    - 失敗 → 拋出 DAOException → 返回 HTTP 500 錯誤

## 三、系統技術實現

根據提供的技術要點列表，系統實現包含以下關鍵技術：

### 3.1 Service完善

- 確保自訂義錯誤編碼處理

### 3.2 JWT 認證處理

- 在 controller 層實現

### 3.3 驗證異常處理

- 完善異常捕獲與回應

### 3.4 新增 jwt token 工具層

- 抽象化 Token 處理邏輯

### 3.5 所有不同層驗證皆有義號碼回傳

### 4.1 登入模組

- 實現用戶驗證邏輯

### 4.2 token管理

- 過期機制
- 銷毀功能
- 持久化處理
- 備存功能

### 4.3 API整合

- 與現有系統整合

### 4.4 實作串接RSA金鑰機制

- 確保系統安全性

## 四、系統整合與重點注意事項

### JWT認證系統整合要點

1. 上線前進行最後測試，特別注意以下幾點：
    - 驗證流程穩定性
    - Token過期機制測試
    - 異常情況處理
    - 高併發環境下的性能測試
2. 系統錯誤碼對照表：
    - API_S001: 密碼錯誤
    - API_S002: 預設錯誤失敗
    - API_S003: 系統內部錯誤
    - U001: Token驗證例外
    - D001: 資料訪問例外

### 歷史比對清單系統注意事項

1. 檔案大小限制：CSV檔案必須在10MB以內
2. 檢查重要欄位：需確保交易序號、身分證字號、金額等關鍵欄位存在且格式正確
3. 資料覆蓋風險：當日重複上傳時需謹慎確認是否覆蓋既有資料
4. 歷史資料比對邏輯：確保比對邏輯準確，避免錯誤標記或遺漏重複交易

### 系統間整合注意事項

1. JWT認證機制需正確整合至歷史比對清單系統中
2. 確保操作Token與JWT Token的區分與正確使用
3. 權限控制：確保只有授權用戶才能執行敏感操作（如覆蓋資料）
4. 日誌記錄：兩系統需有統一的日誌記錄策略，方便問題追蹤

## 五、特殊情況處理

### JWT認證系統

1. 處理Token過期情況
2. 處理非法Token攻擊
3. 處理連線超時情況
4. 處理併發登入問題

### 歷史比對清單系統

1. 檔案格式錯誤處理機制
2. 處理部分資料缺失但可繼續的情況
3. 重複交易的標記與通知機制
4. 資料覆蓋確認機制

## 六、後續工作建議

1. 定期檢查日誌，監控系統運行狀況
2. 考慮增加監控告警機制，及時發現系統異常
3. 定期更新RSA金鑰，提高系統安全性
4. 考慮實現Token黑名單機制，處理已撤銷但未過期的Token
5. 優化歷史比對清單系統的比對演算法，提高大量資料處理效率
6. 實現自動化測試流程，確保每次更新不影響現有功能
7. 建立定期資料備份機制，防止意外資料丟失

